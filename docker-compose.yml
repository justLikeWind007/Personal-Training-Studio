version: "3.9"
services:
  mysql:
    image: mysql:8.4
    container_name: ptstudio-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ptstudio
      MYSQL_USER: ptstudio
      MYSQL_PASSWORD: ptstudio
    ports:
      - "3306:3306"
    command: ["mysqld", "--character-set-server=utf8mb4", "--collation-server=utf8mb4_0900_ai_ci"]
    volumes:
      - ptstudio_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 12
  redis:
    image: redis:7.4
    container_name: ptstudio-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ptstudio_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 20
  rocketmq-namesrv:
    image: apache/rocketmq:5.3.3
    container_name: ptstudio-rocketmq-namesrv
    restart: unless-stopped
    ports:
      - "9876:9876"
    command: sh mqnamesrv
  rocketmq-broker:
    image: apache/rocketmq:5.3.3
    container_name: ptstudio-rocketmq-broker
    restart: unless-stopped
    depends_on:
      - rocketmq-namesrv
    ports:
      - "10911:10911"
      - "10909:10909"
      - "10912:10912"
    environment:
      NAMESRV_ADDR: rocketmq-namesrv:9876
    command: sh mqbroker -n rocketmq-namesrv:9876 --enable-proxy
  rocketmq-dashboard:
    image: apacherocketmq/rocketmq-dashboard:latest
    container_name: ptstudio-rocketmq-dashboard
    restart: unless-stopped
    depends_on:
      - rocketmq-namesrv
    ports:
      - "8088:8080"
    environment:
      JAVA_OPTS: "-Drocketmq.namesrv.addr=rocketmq-namesrv:9876 -Dserver.port=8080"
volumes:
  ptstudio_mysql_data:
  ptstudio_redis_data:
