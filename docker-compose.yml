version: "3.9"
services:
  mysql:
    image: mysql:8.4
    container_name: ptstudio-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ptstudio
      MYSQL_USER: ptstudio
      MYSQL_PASSWORD: ptstudio
    ports:
      - "3306:3306"
    command: ["mysqld", "--character-set-server=utf8mb4", "--collation-server=utf8mb4_0900_ai_ci"]
    volumes:
      - ptstudio_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-uroot", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 12
  redis:
    image: redis:7.4
    container_name: ptstudio-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ptstudio_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 20
  rocketmq-namesrv:
    image: apache/rocketmq:5.3.3
    container_name: ptstudio-rocketmq-namesrv
    restart: unless-stopped
    ports:
      - "9876:9876"
    command: sh mqnamesrv
  rocketmq-broker:
    image: apache/rocketmq:5.3.3
    container_name: ptstudio-rocketmq-broker
    restart: unless-stopped
    depends_on:
      - rocketmq-namesrv
    ports:
      - "10911:10911"
      - "10909:10909"
      - "10912:10912"
    environment:
      NAMESRV_ADDR: rocketmq-namesrv:9876
    command: sh mqbroker -n rocketmq-namesrv:9876 --enable-proxy
  rocketmq-dashboard:
    image: apacherocketmq/rocketmq-dashboard:latest
    container_name: ptstudio-rocketmq-dashboard
    restart: unless-stopped
    depends_on:
      - rocketmq-namesrv
    ports:
      - "8088:8080"
    environment:
      JAVA_OPTS: "-Drocketmq.namesrv.addr=rocketmq-namesrv:9876 -Dserver.port=8080"
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    container_name: ptstudio-elasticsearch
    restart: unless-stopped
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      xpack.security.http.ssl.enabled: "false"
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - ptstudio_es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:9200/_cluster/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
  kibana:
    image: docker.elastic.co/kibana/kibana:8.13.4
    container_name: ptstudio-kibana
    restart: unless-stopped
    depends_on:
      - elasticsearch
    environment:
      ELASTICSEARCH_HOSTS: http://elasticsearch:9200
    ports:
      - "5601:5601"
  nacos:
    image: nacos/nacos-server:v2.4.3
    container_name: ptstudio-nacos
    restart: unless-stopped
    environment:
      MODE: standalone
      SPRING_DATASOURCE_PLATFORM: embedded
      NACOS_AUTH_ENABLE: "false"
    ports:
      - "8848:8848"
    volumes:
      - ptstudio_nacos_data:/home/nacos/data
  sentinel-dashboard:
    image: bladex/sentinel-dashboard:1.8.6
    container_name: ptstudio-sentinel-dashboard
    restart: unless-stopped
    environment:
      - SERVER_PORT=8718
    ports:
      - "8718:8718"
volumes:
  ptstudio_mysql_data:
  ptstudio_redis_data:
  ptstudio_es_data:
  ptstudio_nacos_data:
