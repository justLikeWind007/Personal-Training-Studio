# 中间件生产参数基线 v1

版本：v1  
日期：2026-02-23  
适用范围：`ptstudio` 微服务体系（Spring Cloud Alibaba）

## 1. 目标

将当前开发/测试集群拓扑提升为“可生产落地”的参数基线，覆盖容量、持久化、备份与扩缩容注意事项。

## 2. Nacos 基线

- 部署建议：
  - 3 节点起步（奇数节点）
  - 外置 MySQL（主从或高可用集群）
- 关键参数建议：
  - JVM：`-Xms2g -Xmx2g`（按配置规模提升）
  - `NACOS_AUTH_ENABLE=true`（生产开启鉴权）
  - 配置审计与变更审批流程
- 容量建议：
  - 单节点服务实例数控制在可观测范围，超阈值前扩容
- 备份恢复：
  - MySQL 全量每日、binlog 持续备份
  - 配置导出每次变更后归档
- 扩缩容注意：
  - 扩容前确认 MySQL 连接池上限
  - 缩容前迁移热点流量并确认服务发现稳定

## 3. Redis Sentinel 基线

- 部署建议：
  - 1 主 2 从 + 3 Sentinel
  - AOF 开启，必要时叠加 RDB 周期快照
- 关键参数建议：
  - `appendonly yes`
  - `maxmemory-policy allkeys-lru`（按业务模式选型）
  - `min-replicas-to-write` 与 `min-replicas-max-lag` 保护写入一致性
- 容量建议：
  - 业务 key 需设 TTL，避免内存无上限增长
  - 缓存命中率低于阈值时评估热点隔离
- 备份恢复：
  - AOF/RDB 定时落盘并上传对象存储
  - 演练“从备份恢复 + 主从重建”流程
- 扩缩容注意：
  - 扩容优先加从节点并完成数据同步后切流
  - 主从切换期间限制批量写流量

## 4. RocketMQ 基线

- 部署建议：
  - 2 NameServer + Broker 主从（至少 1 主 1 从）
  - topic 按业务分区，避免单 topic 过热
- 关键参数建议：
  - 消费重试次数与死信队列策略明确
  - 生产端开启重试与幂等键
  - 消费端限制并发，防止下游击穿
- 容量建议：
  - 关注堆积深度、消费延迟、重试率
  - 高峰前预扩容 broker 与磁盘吞吐
- 备份恢复：
  - commitlog 定期归档
  - 关键 topic 消息留存策略分级
- 扩缩容注意：
  - 扩容后重新评估队列分配均衡
  - 缩容前迁移队列并验证消费位点

## 5. Elasticsearch 基线

- 部署建议：
  - 3 节点起步（master/data 角色按规模拆分）
  - 生产开启安全与鉴权（TLS + 访问控制）
- 关键参数建议：
  - JVM：建议不超过节点内存 50%
  - 索引模板统一管理（分片、副本、生命周期）
  - 写入链路采用 bulk + 重试退避
- 容量建议：
  - 单分片目标大小建议控制在合理区间
  - 使用 ILM 做冷热分层与历史归档
- 备份恢复：
  - 周期快照（Snapshot Repository）
  - 至少季度执行一次恢复演练
- 扩缩容注意：
  - 扩容关注分片重平衡窗口
  - 缩容前执行 shard 迁移并校验 green 状态

## 6. 发布前参数检查建议

- Nacos：鉴权是否开启、配置版本是否归档
- Redis：AOF 是否开启、Sentinel 选主是否通过演练
- RocketMQ：关键 topic 堆积是否在阈值内
- ES：集群状态是否 green/yellow 可控，快照任务是否正常

建议结合：

- `./scripts/enterprise_readiness_check.sh`
- `./scripts/middleware_cluster_smoke.sh`
- 故障演练脚本（Redis/Nacos/RocketMQ/ES）
