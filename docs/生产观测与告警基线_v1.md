# 生产观测与告警基线 v1

## 1. 目标

建立统一可观测基线，确保网关与核心业务链路具备可追踪、可度量、可告警能力。

## 2. 日志基线

统一日志上下文字段（MDC）：
- `traceId`
- `requestId`
- `tenantId`
- `storeId`

落地约束：
- 接口入口自动生成/透传 `X-Request-Id`、`X-Trace-Id`
- 日志 pattern 必须输出上述字段

## 3. 指标基线

所有核心服务必须暴露：
- `GET /actuator/health`
- `GET /actuator/metrics`
- `GET /actuator/prometheus`

关键指标（最低要求）：
- `http.server.requests`（QPS、P95/P99、5xx）
- `jvm_threads_live_threads`
- `jvm_memory_used_bytes`
- `system_cpu_usage`

## 4. 告警基线（建议值）

- 网关 5xx 比例 > 1% 持续 5 分钟
- 网关 P95 > 800ms 持续 5 分钟
- `limited(429)` 比例 > 30% 持续 5 分钟
- Ops 异步队列 dead-letter > 0 持续 10 分钟
- ES 写入失败率 > 5% 持续 5 分钟

## 5. 巡检脚本

```bash
./scripts/observability_smoke.sh
```

脚本会检查 gateway/biz/ops 的 health、metrics、prometheus 三类端点。

## 6. 后续演进

- 接入 OpenTelemetry + Trace 后端（Tempo/Jaeger）
- 指标接入 Prometheus + Grafana 看板
- 告警接入 Alertmanager + 企业通知通道
