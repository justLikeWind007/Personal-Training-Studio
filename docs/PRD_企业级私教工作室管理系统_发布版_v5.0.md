# PRD：企业级私教工作室管理系统（v5.0）

版本：v5.0  
日期：2026-02-23  
范围：在 v4.0 基础上完成微服务化、集群化与高并发链路验证

## 1. 背景与目标

v4.0 已完成运营自动化、异步链路、ES 归档与复盘能力。  
v5.0 聚焦“架构可扩展”：从单体演进到可横向扩展的微服务集群，并通过高并发测试验证关键链路稳定性。

## 2. v5.0 核心目标

- 建立服务注册中心与 API 网关入口
- 按领域完成最小服务拆分（Biz / Ops）
- 建立本地集群启动、停止、冒烟脚本
- 建立网关链路高并发测试方案与结果输出
- 建立 Sentinel 限流能力并通过 Nacos 动态下发规则
- 建立最小信任安全基线与巡检流程

## 3. User Stories

### US-301 微服务基础设施（Spring Cloud Alibaba）
**Description:** 作为平台工程师，我希望系统具备标准微服务基础设施，支持服务注册与网关路由。  

**Acceptance Criteria:**
- [ ] 提供注册中心服务（Nacos）
- [ ] 提供 API 网关服务（Gateway）
- [ ] 网关支持按路径将流量转发到不同业务服务
- [ ] 提供基础健康检查能力

### US-302 业务服务拆分
**Description:** 作为架构师，我希望按业务域拆分服务，降低耦合并支持独立扩容。  

**Acceptance Criteria:**
- [ ] 新增 Biz Service（非运营接口）
- [ ] 新增 Ops Service（运营接口）
- [ ] 两服务均支持独立启动与注册
- [ ] 保持租户/门店上下文透传

### US-303 集群运维脚本
**Description:** 作为开发同学，我希望一键拉起/关闭微服务集群，提高联调效率。  

**Acceptance Criteria:**
- [ ] 提供集群启动脚本
- [ ] 提供集群关闭脚本
- [ ] 提供网关入口冒烟脚本
- [ ] 输出关键服务地址与状态

### US-304 高并发链路测试
**Description:** 作为性能工程师，我希望验证网关链路在高并发下的吞吐和延迟表现。  

**Acceptance Criteria:**
- [ ] 提供可配置并发压测脚本
- [ ] 覆盖 `Gateway -> Ops Async Queue` 主链路
- [ ] 输出 TPS/RPS、P95、失败率
- [ ] 覆盖生产者入队 + 消费闭环

### US-305 动态流控与降级
**Description:** 作为平台工程师，我希望可在不停服情况下动态调整限流规则，保护核心链路。  

**Acceptance Criteria:**
- [ ] 网关接入 Sentinel 网关限流
- [ ] Ops 服务接入 Sentinel 流控
- [ ] 限流规则通过 Nacos 动态下发
- [ ] 压测结果可区分成功/限流/失败并生成对比报告

### US-306 中间件集群化演进
**Description:** 作为架构师，我希望中间件具备集群部署基线，以支持高可用演练。  

**Acceptance Criteria:**
- [ ] 提供 Nacos 集群拓扑（含外置 MySQL）
- [ ] 提供 Redis 主从 + Sentinel 拓扑
- [ ] 提供 RocketMQ 多 NameServer 拓扑
- [ ] 提供 ES 三节点拓扑与集群冒烟脚本

### US-307 可观测性与告警基线
**Description:** 作为运维负责人，我希望服务具备统一日志上下文和指标暴露，便于问题定位与告警闭环。  

**Acceptance Criteria:**
- [ ] 日志包含 `traceId/requestId/tenantId/storeId`
- [ ] 服务暴露 `health/metrics/prometheus` 端点
- [ ] 提供可观测性巡检脚本
- [ ] 提供生产观测与告警基线文档
- [ ] 提供 Prometheus 告警规则模板

### US-308 发布与回滚基线
**Description:** 作为交付负责人，我希望有统一的灰度发布与回滚流程，降低线上变更风险。  

**Acceptance Criteria:**
- [ ] 提供发布前检查脚本
- [ ] 提供灰度发布 Runbook
- [ ] 提供回滚操作 Runbook
- [ ] 提供发布检查清单模板

### US-309 故障演练基线
**Description:** 作为SRE，我希望关键中间件具备可重复的故障演练脚本，验证高可用切换能力。  

**Acceptance Criteria:**
- [ ] 提供 Redis Sentinel 主从切换演练脚本
- [ ] 提供 ES 单节点故障演练脚本
- [ ] 提供 Nacos 节点故障演练脚本
- [ ] 提供故障演练手册
- [ ] 提供演练记录模板
- [ ] 演练脚本可在本地集群环境执行

### US-310 最小信任安全基线
**Description:** 作为安全负责人，我希望服务链路具备最小信任机制，降低直连微服务带来的越权风险。  

**Acceptance Criteria:**
- [ ] Gateway 支持自动透传内部调用令牌
- [ ] Biz/Ops 服务支持按配置开启内部令牌校验
- [ ] 提供安全基线设计文档与巡检清单
- [ ] 提供安全巡检脚本并纳入发布流程

## 4. Functional Requirements

- FR-1：系统必须支持服务注册发现
- FR-2：系统必须支持网关统一入口与路由编排
- FR-3：系统必须支持按领域拆分服务并独立部署
- FR-4：系统必须支持一键化集群联调脚本
- FR-5：系统必须支持高并发测试与指标输出
- FR-6：系统必须在链路压测后可验证队列消费闭环
- FR-7：系统必须支持 Sentinel 规则动态下发与生效
- FR-8：系统必须提供中间件集群拓扑与基本可用性验证脚本
- FR-9：系统必须提供统一日志追踪字段与指标可观测基线
- FR-10：系统必须提供可复用告警规则模板
- FR-11：系统必须提供发布前检查与灰度/回滚标准流程
- FR-12：系统必须提供可重复执行的故障演练基线脚本
- FR-13：系统必须支持内部服务令牌校验与安全基线巡检

## 5. 非目标（Out of Scope）

- 不在 v5.0 内实现 Service Mesh（如 Istio）
- 不在 v5.0 内实现 Kubernetes 生产编排
- 不在 v5.0 内实现全链路 APM 平台接入

## 6. 技术约束与考虑

- 延续 Spring Boot + Spring Cloud Alibaba 技术栈（Nacos 注册发现）
- 保持原 `ptstudio-start` 兼容，微服务改造采用增量式并存策略
- 高并发测试先采用轻量脚本化方案，后续可接入 JMeter/k6

## 7. 成功指标

- 集群一键启动成功率 >= 95%
- 网关链路在 100 并发下无功能性错误
- 压测结果可输出完整性能指标（成功率、吞吐、P95）

## 8. 里程碑建议

- M5-1：注册中心 + 网关完成
- M5-2：Biz/Ops 服务拆分完成
- M5-3：集群脚本与冒烟完成
- M5-4：高并发测试与结果基线完成
- M5-5：Sentinel 流控规则动态化完成
- M5-6：中间件集群拓扑与冒烟完成
- M5-7：可观测性与告警基线完成
- M5-8：告警规则模板完成
- M5-9：发布与回滚基线完成
- M5-10：故障演练基线完成
- M5-11：最小信任安全基线完成
