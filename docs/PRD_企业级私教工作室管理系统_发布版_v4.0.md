# PRD：企业级私教工作室管理系统（v4.0）

版本：v4.0  
日期：2026-02-23  
范围：在 v3.0 基础上补齐“自动化运营执行 + 会员旅程闭环 + 中间件驱动稳定性”

## 1. 背景与目标

v3.0 已完成分群、日报、目标、风险预警和策略版本化。  
v4.0 聚焦“从看板到动作闭环”：让系统可以自动生成运营任务、自动触发触达、自动沉淀执行证据。

## 2. v4.0 核心目标

- 建立策略驱动的自动运营任务引擎（按规则生成待办）
- 建立会员旅程节点（新客转化、续费预警、沉睡唤醒）与任务联动
- 建立触达执行记录（短信/企微/电话）统一台账
- 建立中间件化异步任务链路（Redis + MQ）提升可靠性
- 建立运营动作复盘看板（任务完成率、转化率、时效）

## 3. User Stories

### US-201 自动运营任务引擎
**Description:** 作为总部运营，我希望系统按策略自动生成门店待办任务，减少人工派单。  

**Acceptance Criteria:**
- [ ] 提供任务规则配置接口（触发条件、优先级、负责人）
- [ ] 支持按日批量生成门店任务
- [ ] 任务具备状态流转（TODO/DOING/DONE/CLOSED）
- [ ] 任务生成与变更写入审计日志

### US-202 会员旅程节点联动
**Description:** 作为门店店长，我希望按会员旅程阶段查看任务建议，提升转化效率。  

**Acceptance Criteria:**
- [ ] 支持新客7天转化节点识别
- [ ] 支持续费前7天预警节点识别
- [ ] 支持30天未到店沉睡节点识别
- [ ] 节点与自动任务引擎联动生成任务

### US-203 触达执行台账
**Description:** 作为运营专员，我希望记录每次触达动作与结果，便于复盘。  

**Acceptance Criteria:**
- [ ] 提供触达记录新增接口（渠道、内容摘要、执行人、结果）
- [ ] 支持按会员/任务查询触达历史
- [ ] 支持导出 CSV
- [ ] 关键字段变更进入审计

### US-204 中间件异步任务链路
**Description:** 作为平台工程师，我希望运营任务生成和通知分发通过中间件异步执行，保证峰值稳定。  

**Acceptance Criteria:**
- [ ] 任务生成事件写入 Redis 队列或 Stream
- [ ] 消费端从 MQ 拉取并执行任务分发
- [ ] 失败任务具备重试与死信记录
- [ ] 提供链路健康检查接口

### US-205 运营复盘看板
**Description:** 作为管理层，我希望看到任务执行效果并按门店对比。  

**Acceptance Criteria:**
- [ ] 提供任务完成率、超时率、转化率统计
- [ ] 支持总部维度多门店横向对比
- [ ] 支持按日期区间筛选
- [ ] 支持导出复盘报表

## 4. Functional Requirements

- FR-1：系统必须支持策略驱动的自动任务生成
- FR-2：系统必须支持会员旅程节点识别并联动任务
- FR-3：系统必须支持触达执行记录与查询导出
- FR-4：系统必须支持中间件异步链路、重试与死信
- FR-5：系统必须支持运营复盘核心指标统计
- FR-6：所有能力必须保持租户门店隔离
- FR-7：所有关键动作必须具备审计日志
- FR-8：异步任务链路必须具备可观测性（状态、耗时、失败原因）

## 5. 非目标（Out of Scope）

- 不在 v4.0 内实现真实短信供应商计费对接
- 不在 v4.0 内实现复杂机器学习推荐
- 不在 v4.0 内实现跨租户统一数据湖分析

## 6. 技术约束与考虑

- 延续现有 DDD4J 分层，优先完成内存实现与测试，再扩展 mysql profile
- 中间件优先采用本地可运行方案：Redis + RabbitMQ（或兼容实现）
- 异步链路必须保留幂等键与重试次数
- 回归测试继续纳入 `smoke/security/regression` 分层

## 7. 成功指标

- 自动生成任务占比达到 70%+
- 任务按期完成率提升 30%
- 关键旅程节点触达率提升 40%
- 异步任务失败自动恢复率达到 95%+

## 8. 里程碑建议

- M4-1：自动任务引擎 + 旅程节点识别上线
- M4-2：触达台账 + 导出能力上线
- M4-3：中间件异步链路 + 健康检查上线
- M4-4：复盘看板 + v4.0 验收闭环
