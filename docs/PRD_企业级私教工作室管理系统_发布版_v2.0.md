# PRD: 企业级私教工作室管理系统 v2.0

## 1. Introduction/Overview

在 v1.1 已完成单店 MVP 闭环（线索、会员、预约、签到课消、收银退款、提成报表、审计）的基础上，v2.0 目标是将系统升级为“多门店总部治理平台”，解决总部视角下的跨门店运营、财务一致性、权限治理与经营分析问题。

本版本面向“集团化经营”场景，核心是三件事：
- 把单门店能力扩展为可管控的多门店能力；
- 把账务和履约链路从“可用”提升为“可核、可追、可稽核”；
- 把权限和组织体系从后端能力提升到可配置、可落地的管理流程。

## 2. Goals

- 支持一个租户下多门店统一管理，并保证门店间数据隔离。
- 建立总部-门店组织与权限模型，实现角色/按钮级权限的可配置落地。
- 建立跨门店财务与履约看板，提供总部级经营分析。
- 支持退款/课消/支付全链路稽核与异常补偿闭环。
- 将关键链路上线标准提升到“数据库级一致性 + 审计可追溯 + 越权可检测”。

## 3. User Stories

### US-001: 多门店组织管理
**Description:** 作为总部管理员，我希望管理门店组织结构和启停状态，以便统一治理集团门店。

**Acceptance Criteria:**
- [ ] 支持总部创建/编辑/停用门店。
- [ ] 支持按租户查询门店列表与状态。
- [ ] 门店停用后，门店写操作被拒绝并返回可读错误。
- [ ] 所有门店组织变更写入审计日志。
- [ ] 类型检查与测试通过。

### US-002: 总部-门店数据权限模型
**Description:** 作为系统管理员，我希望配置总部角色和门店角色的数据权限范围，以防止跨店越权。

**Acceptance Criteria:**
- [ ] 支持角色绑定数据范围：`TENANT_ALL`、`STORE_ASSIGNED`、`SELF_ONLY`。
- [ ] 所有查询接口按数据范围自动过滤。
- [ ] 非授权访问返回标准错误码并记录安全审计日志。
- [ ] 提供权限回归测试：跨租户、跨门店、跨角色。
- [ ] 类型检查与测试通过。

### US-003: 角色与按钮级权限配置页面（管理端）
**Description:** 作为店长/总部管理员，我希望在页面可配置角色权限和按钮权限，减少人工改配置成本。

**Acceptance Criteria:**
- [ ] 提供“角色管理页”：创建角色、分配菜单、分配按钮权限。
- [ ] 提供“用户授权页”：用户与角色绑定。
- [ ] 权限变更后在 1 分钟内生效（可通过缓存刷新策略实现）。
- [ ] 前端按钮隐藏/禁用与后端鉴权一致。
- [ ] Verify in browser using dev-browser skill。
- [ ] 类型检查与测试通过。

### US-004: 财务一致性稽核中心
**Description:** 作为财务，我希望看到支付、退款、课消、提成的差异清单，便于每日对账与问题闭环。

**Acceptance Criteria:**
- [ ] 提供日结稽核页：订单金额、实收、退款、课消、提成汇总。
- [ ] 提供异常明细列表（缺回调、重复课消、超额退款、状态不一致）。
- [ ] 支持异常任务重试和人工标记已处理。
- [ ] 稽核结果支持按门店导出。
- [ ] 类型检查与测试通过。

### US-005: 预约/课消事件驱动补偿
**Description:** 作为研发运维，我希望关键事件具备 outbox 投递与补偿策略，避免异步链路丢失导致数据不一致。

**Acceptance Criteria:**
- [ ] 预约与课消关键事件写入 outbox，状态机可追踪。
- [ ] 提供事件重试任务和死信处理机制。
- [ ] 提供 outbox 监控指标：积压量、失败率、重试次数。
- [ ] 异常演练脚本可复现并验证补偿成功。
- [ ] 类型检查与测试通过。

### US-006: 总部经营 BI 看板
**Description:** 作为总部运营，我希望按租户和门店查看经营趋势，支持决策与督导。

**Acceptance Criteria:**
- [ ] 提供总部总览（营收、退款、到课、复购、客单价）。
- [ ] 支持门店排行与时间趋势对比。
- [ ] 支持统一指标口径配置与展示。
- [ ] 提供门店钻取到明细能力。
- [ ] Verify in browser using dev-browser skill。
- [ ] 类型检查与测试通过。

## 4. Functional Requirements

- FR-1: 系统必须支持租户下多门店管理（新增、编辑、停用、查询）。
- FR-2: 系统必须支持总部与门店两级组织角色体系。
- FR-3: 系统必须支持角色的数据范围配置并在接口层自动生效。
- FR-4: 系统必须提供角色权限与按钮权限可视化配置能力。
- FR-5: 系统必须在关键写操作中保持数据库事务一致性。
- FR-6: 系统必须提供支付/退款/课消/提成的日结稽核与异常清单。
- FR-7: 系统必须支持 outbox 事件重试、失败告警、人工补偿。
- FR-8: 系统必须提供总部级 BI 报表与门店钻取分析。
- FR-9: 系统必须记录关键安全事件（越权尝试、权限变更、补偿执行）。
- FR-10: 系统必须提供安全回归测试基线并纳入 CI。

## 5. Non-Goals (Out of Scope)

- 不引入硬件设备联动（门禁闸机、体测设备）。
- 不实现复杂税务/发票平台对接（仅保留接口扩展位）。
- 不在 v2.0 引入 AI 排班、AI 销售推荐等算法能力。
- 不实现跨法人总账合并（仅做经营口径汇总）。

## 6. Design Considerations

- 管理端保持现有信息架构，新增“总部控制台”入口。
- 总部视角与门店视角的筛选器需统一（租户、门店、日期）。
- 权限配置页需提供变更预览与确认提示，降低误操作风险。

## 7. Technical Considerations

- 继续沿用现有 Spring Boot 多模块与仓储抽象模式。
- `mysql profile` 为生产主路径，`test profile` 保持快速回归。
- 事件发布采用 outbox-first 模式，消息中间件作为后续投递层。
- 审计与安全日志采用统一结构，支持按 `tenant/store/user/action` 检索。
- 建议新增集成测试分层：`api-smoke`、`security-regression`、`finance-reconcile`。

## 8. Success Metrics

- 多门店上线后：总部可管理门店数量 >= 20 家（无核心链路性能劣化）。
- 越权回归测试覆盖率达到 100%（核心 API）。
- 财务稽核异常闭环时长较 v1.1 基线下降 50%。
- 日结准确率达到 99.99%。
- 关键接口 SLO：P95 < 300ms，可用性 >= 99.9%。

## 9. Open Questions

- OQ-1: 门店停用后的历史数据可见策略是否需要细粒度开关？
- OQ-2: 总部是否需要“代门店操作”能力及其审计策略？
- OQ-3: BI 指标是否对接现有数据中台，还是继续在业务库聚合？
- OQ-4: outbox 到 MQ 的最终投递组件选型是否固定为 RocketMQ？
- OQ-5: 角色权限配置是否要求灰度发布与回滚版本管理？
