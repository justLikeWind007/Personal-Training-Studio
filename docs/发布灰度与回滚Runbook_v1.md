# 发布灰度与回滚 Runbook v1

## 1. 目标

建立标准化发布流程，降低变更风险，确保出现异常时可快速回滚。

## 2. 发布前检查

执行：

```bash
./scripts/release_precheck.sh
```

必须满足：
- Nacos 就绪
- gateway/biz/ops 健康检查通过
- prometheus 指标端点可访问
- 网关关键登录链路可用

## 3. 灰度发布步骤

1. 发布 5%-10% 实例（或按租户白名单路由）
2. 观察 10-15 分钟：
   - 5xx 比例
   - P95 延迟
   - Sentinel 限流比例
   - 异步队列 dead-letter
3. 无异常后放量到 50%
4. 继续观察 10 分钟后全量

## 4. 回滚触发条件

满足任一条件立即回滚：
- 5xx 比例 > 1% 且持续 5 分钟
- P95 > 800ms 且持续 5 分钟
- 核心链路错误（登录、入队、复盘查询）持续失败
- 业务侧明确反馈严重故障

## 5. 回滚步骤

1. 网关路由切回旧版本实例
2. 下线新版本实例
3. 恢复上一版本配置（Nacos）
4. 验证：health/metrics/prometheus + 关键业务接口
5. 发布事故记录与根因分析任务

## 6. 变更记录模板

- 变更单号：
- 发布人：
- 发布时间：
- 灰度范围：
- 观察指标：
- 是否回滚：
- 结论：
