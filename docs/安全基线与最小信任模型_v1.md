# 安全基线与最小信任模型 v1

## 1. 目标

在现有 Spring Cloud Alibaba 微服务链路上补齐最小信任能力，默认保持兼容，支持按环境逐步开启服务间鉴权。

## 2. 设计原则

- 外部流量统一从 Gateway 进入，业务服务不直接暴露公网入口
- 服务间调用通过 `X-Internal-Token` 做轻量内部令牌校验
- 基线能力默认关闭（`required=false`），避免影响本地开发与历史脚本
- 生产环境通过环境变量统一开启并轮换令牌

## 3. 配置说明

网关配置（自动透传内部令牌）：

```yaml
security:
  internal-token:
    value: ${INTERNAL_TOKEN_VALUE:}
```

业务服务配置（校验内部令牌）：

```yaml
security:
  internal-token:
    required: ${INTERNAL_TOKEN_REQUIRED:false}
    value: ${INTERNAL_TOKEN_VALUE:}
```

建议生产环境设置：

- `INTERNAL_TOKEN_REQUIRED=true`
- `INTERNAL_TOKEN_VALUE=<长度>=32 的随机字符串`

## 4. 请求链路行为

- 请求经过 Gateway 且网关已配置 `INTERNAL_TOKEN_VALUE`：
  - 若请求未携带 `X-Internal-Token`，网关自动注入
  - 若请求已携带该请求头，网关保持原值（便于灰度兼容）
- Biz/Ops 服务开启 `required=true` 后：
  - `/api/**` 请求必须携带且匹配 `X-Internal-Token`
  - 缺失、空值或不匹配会被拦截并返回错误

## 5. 上线建议

- 第一步：预发布先设置 `INTERNAL_TOKEN_VALUE`，保持 `required=false`
- 第二步：观察链路日志和巡检脚本输出，确认 Gateway 已稳定透传
- 第三步：灰度服务开启 `INTERNAL_TOKEN_REQUIRED=true`
- 第四步：全量开启，并将直连服务端口流量收敛到内网

## 6. 风险与后续

- 当前为共享密钥模式，需通过配置中心和密钥轮换规范降低泄漏风险
- 下一版本可升级为 mTLS 或服务身份 JWT（如 SPIFFE/SPIRE 体系）
